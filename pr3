import React, { useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  Alert,
  Modal,
  TextInput,
} from "react-native";

// Моковые данные записей
const mockRecords = [
  {
    id: "1",
    date: "2024-12-15",
    time: "10:00",
    service: "Стрижка мужская",
    price: 1200,
    master: "Иван Петров",
  },
  {
    id: "2",
    date: "2024-12-16",
    time: "14:00",
    service: "Окрашивание волос",
    price: 2500,
    master: "Мария Сидорова",
  },
  {
    id: "3",
    date: "2024-12-17",
    time: "11:00",
    service: "Маникюр",
    price: 800,
    master: "Анна Козлова",
  },
];

export default function MyRecordsScreen({ navigation }) {
  const [records, setRecords] = useState(mockRecords);
  const [modalVisible, setModalVisible] = useState(false);
  const [cancelReason, setCancelReason] = useState("");
  const [selectedRecord, setSelectedRecord] = useState(null);
  const [rescheduleModalVisible, setRescheduleModalVisible] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  const [selectedTime, setSelectedTime] = useState(null);

  const handleCancel = (record) => {
    setSelectedRecord(record);
    setModalVisible(true);
  };

  // Исправление 1 - иммутабельность
const confirmCancel = () => {
  if (!cancelReason.trim()) {
    Alert.alert("Ошибка", "Пожалуйста, укажите причину отмены");
    return;
  }
  setRecords(records.filter((r) => r.id !== selectedRecord.id));
  setModalVisible(false);
  setCancelReason("");
  setSelectedRecord(null);
  Alert.alert("Успех", "Запись отменена");
};

// Исправление 2 - консистентные имена
const confirmReschedule = () => {
  if (!selectedDate || !selectedTime) {
    Alert.alert("Ошибка", "Пожалуйста, выберите дату и время");
    return;
  }
  const updatedRecords = records.map((record) =>
    record.id === selectedRecord.id
      ? {
          ...record,
          date: selectedDate,
          time: selectedTime,
        }
      : record
  );
  setRecords(updatedRecords);
  setRescheduleModalVisible(false);
  setSelectedRecord(null);
  setSelectedDate(null);
  setSelectedTime(null);
  Alert.alert("Успех", "Запись перенесена");
};

// Исправление 3 - корректный ключ
{records.map((record) => (
  <View key={record.id} style={styles.recordCard}>
    <Text>{record.service}</Text>
  </View>
))}


  const availableTimes = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];

  // Ошибка 4: Пропущена проверка типов (PropTypes)

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString("ru-RU", {
      day: "numeric",
      month: "long",
      year: "numeric",
    });
  };

  return (
    <View style={styles.container}>
      {records.length === 0 ? (
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyText}>У вас нет активных записей</Text>
        </View>
      ) : (
        <ScrollView style={styles.scrollView}>
          {records.map((record, idx) => ( // Ошибка 3: Индекс как ключ
            <View key={idx} style={styles.recordCard}>
              <View style={styles.recordHeader}>
                <Text style={styles.recordDate}>
                  {formatDate(record.date)} в {record.time}
                </Text>
                <Text style={styles.recordPrice}>{record.price} ₽</Text>
              </View>
              <Text style={styles.serviceName}>{record.service}</Text>
              <Text style={styles.masterName}>Мастер: {record.master}</Text>
              <View style={styles.buttonsContainer}>
                <TouchableOpacity
                  style={[styles.button, styles.rescheduleButton]}
                  onPress={() => handleReschedule(record)}
                >
                  <Text style={styles.rescheduleButtonText}>Перенести</Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={[styles.button, styles.cancelButton]}
                  onPress={() => handleCancel(record)}
                >
                  <Text style={styles.cancelButtonText}>Отменить</Text>
                </TouchableOpacity>
              </View>
            </View>
          ))}
        </ScrollView>
      )}

      {/* Модальное окно отмены записи */}
      <Modal
        animationType="slide"
        transparent={true}
        visible={modalVisible}
        onRequestClose={() => setModalVisible(false)}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Отмена записи</Text>
            <Text style={styles.modalText}>
              Вы уверены, что хотите отменить запись на{" "}
              {selectedRecord && formatDate(selectedRecord.date)} в{" "}
              {selectedRecord?.time}?
            </Text>
            <Text style={styles.reasonLabel}>Укажите причину отмены:</Text>
            <TextInput
              style={styles.reasonInput}
              multiline
              numberOfLines={3}
              placeholder="Причина отмены..."
              value={cancelReason}
              onChangeText={setCancelReason}
            />
            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelModalButton]}
                onPress={() => {
                  setModalVisible(false);
                  setCancelReason("");
                }}
              >
                <Text style={styles.cancelModalButtonText}>Назад</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[styles.modalButton, styles.confirmButton]}
                onPress={confirmCancel}
              >
                <Text style={styles.confirmButtonText}>Подтвердить отмену</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Модальное окно переноса записи */}
      <Modal
        animationType="slide"
        transparent={true}
        visible={rescheduleModalVisible}
        onRequestClose={() => setRescheduleModalVisible(false)}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Перенос записи</Text>
            <Text style={styles.modalText}>
              Перенести "{selectedRecord?.service}" на другую дату
            </Text>
            <Text style={styles.dateLabel}>Выберите дату:</Text>
            <View style={styles.dateButtons}>
              {["2024-12-18", "2024-12-19", "2024-12-20"].map((date) => (
                <TouchableOpacity
                  key={date}
                  style={[
                    styles.dateButton,
                    selectedDate === date && styles.dateButtonActive,
                  ]}
                  onPress={() => setSelectedDate(date)}
                >
                  <Text
                    style={[
                      styles.dateButtonText,
                      selectedDate === date && styles.dateButtonTextActive,
                    ]}
                  >
                    {formatDate(date)}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
            {selectedDate && (
              <>
                <Text style={styles.dateLabel}>Выберите время:</Text>
                <View style={styles.timeGrid}>
                  {availableTimes.map((time) => (
                    <TouchableOpacity
                      key={time}
                      style={[
                        styles.timeButton,
                        selectedTime === time && styles.timeButtonActive,
                      ]}
                      onPress={() => setSelectedTime(time)}
                    >
                      <Text
                        style={[
                          styles.timeButtonText,
                          selectedTime === time && styles.timeButtonTextActive,
                        ]}
                      >
                        {time}
                      </Text>
                    </TouchableOpacity>
                  ))}
                </View>
              </>
            )}
            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelModalButton]}
                onPress={() => {
                  setRescheduleModalVisible(false);
                  setSelectedDate(null);
                  setSelectedTime(null);
                }}
              >
                <Text style={styles.cancelModalButtonText}>Назад</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[
                  styles.modalButton,
                  styles.confirmButton,
                  (!selectedDate || !selectedTime) && styles.buttonDisabled,
                ]}
                onPress={confirmReschedule}
                disabled={!selectedDate || !selectedTime}
              >
                <Text style={styles.confirmButtonText}>Перенести</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
}
